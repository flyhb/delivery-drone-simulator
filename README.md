# Delivery Drone Station Simulator

This project simulates a delivery <b>drone station</b> that integrates with the Hummingbird contract. It’s intended as a testnet tool to validate the protocol and the user experience.

The simulator consists of two parts:

* **Device** – emulates the firmware running on the physical device.  It manages a persistent device key, checks registration status and signs permit messages.  Once registered it enters an example “operation” loop.
* **Client** – represents a companion application used by the device owner or operator.  It collects the owner’s private key, coordinates the registration process and pays the ioID registration fee on behalf of the device.

## Prerequisites

* Node.js version 18 or 20 (Hardhat and Ethers do not support Node 23 at the time of writing)
* Yarn or npm installed globally
* An RPC endpoint for the target chain (e.g. a local Hardhat node or the Berachain Bepolia testnet)
* Deployed ioID infrastructure (registry, store, device NFT contract etc.)

## Setup

1. Install dependencies:

   ```bash
   git clone https://github.com/flyhb/delivery-drone-simulator.git
   cd delivery-drone-simulator
   npm install
   ```

2. Create and fill `.env`
Copy the provided `.env.example` to `.env` and fill in the required values.  

- `RPC_URL`: any Bepolia RPC (see: https://chainlist.org/chain/80069)
- `CHAIN_ID`: 80069 for Bepolia  
- `HUMMINGBIRD`: hummingbird dapp contract address (see current deployment [here](https://github.com/flyhb/hummingbird#berachain-testnet))
- `IOID_STORE`: ioID store contract address (see current deployment [here](https://github.com/flyhb/ioID-contracts/blob/main/chain-deployments/berachain.md))
- `HEARTBEAT_MS`: how often the device sends a proof of liveness to the contract.
Notes: there is currently no min/max enforced. The device address must hold <b>BERA</b> to pay gas (subject to change). Use a longer interval to save BERA, or shorter to mine more HB (currently 1 HB per proof). At **~1 proof/min, 1 BERA lasts ≈ 5 hours**.
- `OWNER_PRIVATE_KEY`: *(optional)* your station‑owner account. It needs some BERA for the device registration fee and gas. The current registration price (low) can also be found [here](https://github.com/flyhb/ioID-contracts/blob/main/chain-deployments/berachain.md). If not set, you’ll be prompted during bootstrap.

3. Build the TypeScript sources (or run directly with ts-node):

   ```bash
   # Compile to JavaScript
   npm run build

   # Or run with ts-node (used by `npm start`)
   npm start
   ```

## Running the simulator

The default start script launches the **client**.  On startup it:

1. Loads or creates a persistent device key and displays the device address. 
**→ Copy the device address and send some BERA to it.**

2. Loads or creates the rest of the configuration (see `device_config.json`), including
- GPS location of the station
- The simulated drone speed
- Maximum service range (longer trips will be ignored)

3. Checks if the device is already registered on-chain.

4. If the device is not registered it prompts for the owner’s private key (unless `OWNER_PRIVATE_KEY` is set in the `.env`).

5. Verifies that the owner holds a Hummingbird Device NFT (required for registration).
 **→ mint one at: https://test.flyhummingbird.io/contribute**

6. The device signs an **EIP‑712 permit** authorizing the owner to register it.  The client then **submits the registration** tx and pays the required fee.  After confirmation, the device is registered (bound to the owner's account) and the owner receives an **ioID NFT** representing ownership and entitling them to any incentives and payments generated by the device (import the HB token address in Metamask, find the contract address [here](https://github.com/flyhb/hummingbird#berachain-testnet)).
6. Once registered, the device enters an **operation loop** where it periodically sends proofs of liveness, and (in the simulator) can monitor incoming delivery requests and “fly” simulated missions according to the configured speed and range limits. 

